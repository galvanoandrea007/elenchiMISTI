<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Lettura JSON / XML</title>
    <style>
        body {
            font-family: "Trebuchet MS", sans-serif;
            background-color: #fafafa;           
            margin: 30px;
        }

        h2 {
            color: #5a5a9f;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        th {
            background-color: #5a5a9f; 
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f0f0ff; 
        }

        #output {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h2>Carica un file JSON o XML</h2>
<input type="file" id="fileInput" accept=".json,.xml">

<div id="output"></div>

<script>

document.getElementById("fileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        const content = e.target.result;
        let data;

        try {
            data = JSON.parse(content);
            renderData(data);
            return;
        } catch (e) {}

        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, "application/xml");

            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                document.getElementById("output").innerHTML =
                    "<p style='color:red;'>Formato XML non valido.</p>";
                return;
            }

            data = xmlToJson(xmlDoc);
            renderData(data);
        } catch (e) {
            document.getElementById("output").innerHTML =
                "<p style='color:red;'>Errore nella lettura del file.</p>";
        }
    };

    reader.readAsText(file);
});



function xmlToJson(xml) {
    let obj = {};

    if (xml.nodeType === 1) {
        if (xml.attributes.length > 0) {
            obj["@attributes"] = {};
            for (let attr of xml.attributes) {
                obj["@attributes"][attr.name] = attr.value;
            }
        }
    } else if (xml.nodeType === 3) {
        return xml.nodeValue.trim();
    }

    if (xml.hasChildNodes()) {
        for (let child of xml.childNodes) {
            const nodeName = child.nodeName;
            const value = xmlToJson(child);

            if (value !== "") {
                if (!obj[nodeName]) obj[nodeName] = value;
                else {
                    if (!Array.isArray(obj[nodeName])) obj[nodeName] = [obj[nodeName]];
                    obj[nodeName].push(value);
                }
            }
        }
    }
    return obj;
}


function renderData(data) {
    const container = document.getElementById("output");

    if (!Array.isArray(data)) {
        const candidate = Object.values(data).find(v => Array.isArray(v));
        data = candidate || [data];
    }

    if (data.length === 0) {
        container.innerHTML = "<p>Nessun dato da mostrare.</p>";
        return;
    }

    const columns = [...new Set(data.flatMap(obj => Object.keys(obj)))];

    let html = "<table><thead><tr>";
    columns.forEach(c => html += `<th>${c}</th>`);
    html += "</tr></thead><tbody>";

    data.forEach(row => {
        html += "<tr>";
        columns.forEach(c => {
            let val = row[c] ?? "";
            if (typeof val === "object") val = JSON.stringify(val);
            html += `<td>${val}</td>`;
        });
        html += "</tr>";
    });

    html += "</tbody></table>";
    container.innerHTML = html;
}
</script>

</body>
</html>
